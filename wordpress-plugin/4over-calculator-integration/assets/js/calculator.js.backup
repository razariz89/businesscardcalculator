(function($) {
    'use strict';

    let calculatorData = {
        price: 0,
        options: {},
        details: ''
    };

    // Listen for messages from iframe
    window.addEventListener('message', function(event) {
        // Verify origin (update this with your actual calculator URL)
        const allowedOrigins = [
            'https://v0-businesscardcalculator.vercel.app',
            'http://localhost:3000'
        ];

        if (!allowedOrigins.includes(event.origin)) {
            return;
        }

        const data = event.data;

        // Handle different message types
        if (data.type === 'CALCULATOR_DATA') {
            handleCalculatorData(data);
        } else if (data.type === 'ADD_TO_CART') {
            handleAddToCart(data);
        } else if (data.type === 'RESIZE_IFRAME') {
            handleIframeResize(data);
        }
    });

    function handleCalculatorData(data) {
        console.log('Calculator data received:', data);

        calculatorData = {
            price: data.price || 0,
            options: data.options || {},
            details: data.details || '',
            productId: data.productId || '',
            categoryId: data.categoryId || ''
        };

        // Update hidden fields
        $('#fourover-selected-options').val(JSON.stringify(calculatorData.options));
        $('#fourover-calculated-price').val(calculatorData.price);
        $('#fourover-product-details').val(calculatorData.details);

        // Update price display
        updatePriceDisplay(calculatorData.price);

        // Enable add to cart button if price is available
        if (calculatorData.price > 0) {
            $('#fourover-add-to-cart-btn').prop('disabled', false);
        }

        // Trigger custom event
        $(document).trigger('fourover_calculator_updated', [calculatorData]);
    }

    function handleAddToCart(data) {
        console.log('Add to cart triggered from calculator:', data);

        // Use calculator data
        const cartData = {
            price: data.price || calculatorData.price,
            options: data.options || calculatorData.options,
            details: data.details || calculatorData.details
        };

        addToCartViaAjax(cartData);
    }

    function handleIframeResize(data) {
        if (data.height) {
            $('#fourover-calculator-iframe').css('min-height', data.height + 'px');
        }
    }

    function updatePriceDisplay(price) {
        if (!price) return;

        // Find WooCommerce price element and update it
        const priceElement = $('.summary .price .amount');
        if (priceElement.length) {
            const formattedPrice = formatPrice(price);
            priceElement.html(formattedPrice);
        }
    }

    function formatPrice(price) {
        // Get WooCommerce currency settings if available
        const currencySymbol = '$'; // You can make this dynamic
        return currencySymbol + parseFloat(price).toFixed(2);
    }

    function addToCartViaAjax(data) {
        if (!fouroverCalc) {
            console.error('fouroverCalc object not found');
            return;
        }

        const requestData = {
            action: 'fourover_add_to_cart',
            nonce: fouroverCalc.nonce,
            product_id: fouroverCalc.productId,
            price: data.price,
            options: JSON.stringify(data.options),
            details: data.details
        };

        $.ajax({
            url: fouroverCalc.ajaxUrl,
            type: 'POST',
            data: requestData,
            beforeSend: function() {
                // Show loading state
                $('.single_add_to_cart_button').prop('disabled', true).text('Adding...');
            },
            success: function(response) {
                if (response.success) {
                    // Redirect to cart or show success message
                    if (response.data.cart_url) {
                        window.location.href = response.data.cart_url;
                    } else {
                        showNotice('Product added to cart!', 'success');
                    }
                } else {
                    showNotice(response.data.message || 'Failed to add to cart', 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX error:', error);
                showNotice('An error occurred. Please try again.', 'error');
            },
            complete: function() {
                $('.single_add_to_cart_button').prop('disabled', false).text('Add to cart');
            }
        });
    }

    function showNotice(message, type) {
        const noticeClass = type === 'success' ? 'woocommerce-message' : 'woocommerce-error';
        const notice = $('<div class="' + noticeClass + '">' + message + '</div>');

        $('.woocommerce-notices-wrapper').html(notice);

        $('html, body').animate({
            scrollTop: notice.offset().top - 100
        }, 500);

        setTimeout(function() {
            notice.fadeOut();
        }, 5000);
    }

    // Intercept default add to cart button
    $(document).ready(function() {
        const $addToCartButton = $('.single_add_to_cart_button');
        const $calculatorContainer = $('#fourover-calculator-container');

        if ($calculatorContainer.length && $addToCartButton.length) {
            // Override add to cart button behavior
            $addToCartButton.on('click', function(e) {
                // Check if calculator has data
                if (calculatorData.price > 0) {
                    e.preventDefault();

                    // Send message to iframe or use stored data
                    const iframe = document.getElementById('fourover-calculator-iframe');
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage({
                            type: 'REQUEST_ADD_TO_CART'
                        }, '*');
                    } else {
                        addToCartViaAjax(calculatorData);
                    }
                } else {
                    // Let default behavior happen if no calculator data
                    console.warn('No calculator data available, using default add to cart');
                }
            });
        }

        // Auto-resize iframe
        function resizeIframe() {
            const iframe = $('#fourover-calculator-iframe');
            if (iframe.length) {
                // Send message to iframe to get its content height
                iframe[0].contentWindow.postMessage({
                    type: 'GET_HEIGHT'
                }, '*');
            }
        }

        // Resize on load
        $('#fourover-calculator-iframe').on('load', function() {
            setTimeout(resizeIframe, 1000);
        });

        // Resize on window resize
        $(window).on('resize', resizeIframe);
    });

    // Send initial data to iframe
    $(window).on('load', function() {
        const iframe = document.getElementById('fourover-calculator-iframe');
        if (iframe && iframe.contentWindow && fouroverCalc) {
            // Wait for iframe to load
            setTimeout(function() {
                iframe.contentWindow.postMessage({
                    type: 'INIT_CONFIG',
                    categoryId: fouroverCalc.categoryId,
                    productId: fouroverCalc.productId,
                    embedded: true
                }, '*');
            }, 1500);
        }
    });

})(jQuery);
